name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: 🧹 Clean and Fix Build Directories
        run: |
          rm -rf build tmp_build
          mkdir -p build/ios/Release-iphoneos tmp_build/ios/Release-iphoneos
          sudo chown -R runner:staff build tmp_build
          sudo chmod -R u+rwX build tmp_build

      - name: 🛠️ Set Safe Build Permissions
        run: |
          sudo chown -R runner:staff .
          sudo chmod -R u+rwX,go-w .
          mkdir -p tmp_build/ios/{Release-iphoneos,archive,ipa}
          chmod -R u+rwX tmp_build

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Update CocoaPods Repo
        run: pod repo update
        working-directory: ios

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: 🔗 Symlink build directory (workaround)
        run: |
          rm -rf build
          ln -s tmp_build build

      - name: 🔧 Clean Previous Builds (Optional but Recommended)
        run: flutter clean

      - name: 🚀 Build iOS Release (No Code Sign)
        run: flutter build ios --release --no-codesign --build-dir tmp_build --verbose
        env:
          SYMROOT: ${{ github.workspace }}/tmp_build/ios

      - name: 📁 Create IPA Payload Folder
        run: mkdir -p tmp_build/ios/iphoneos/Payload

      - name: 📦 Move Runner.app into Payload
        run: mv tmp_build/ios/iphoneos/Runner.app tmp_build/ios/iphoneos/Payload/

      - name: 🗜️ Archive IPA
        run: |
          cd tmp_build/ios/iphoneos
          zip -r -9 FlutterApp.ipa Payload

      - name: ☁️ Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-Unsigned-IPA
          path: tmp_build/ios/iphoneos/FlutterApp.ipa
