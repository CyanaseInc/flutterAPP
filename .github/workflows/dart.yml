name: cyanase_ipa

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ğŸš€ Build iOS Unsigned IPA (No Signing, Fixes Sandbox & Pods)
    runs-on: macos-14

    steps:
      - name: ğŸ›ï¸ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ”§ Set up Ruby for CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: ğŸ’™ Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.2'
          channel: stable
          architecture: x64

      - name: ğŸ§¹ Clean Flutter and Get Dependencies
        run: |
          flutter clean
          flutter pub get

      - name: ğŸ CocoaPods Install
        run: |
          cd ios
          pod deintegrate || true
          pod cache clean --all
          pod install --repo-update
          cd ..

      - name: ğŸ”“ Fix Permissions (No sudo)
        run: chmod -R 777 .

      - name: ğŸ§¹ Clean Derived Data
        run: rm -rf ${{ github.workspace }}/build/ios_derived || true

      - name: ğŸ›  Create writable Derived Data folder
        run: mkdir -p ${{ github.workspace }}/build/ios_derived

      - name: ğŸ”§ Set XCODE_DERIVED_DATA_PATH, SYMROOT, DERIVED_DATA_PATH
        run: |
          echo "XCODE_DERIVED_DATA_PATH=${{ github.workspace }}/build/ios_derived" >> $GITHUB_ENV
          echo "SYMROOT=${{ github.workspace }}/build/ios_derived" >> $GITHUB_ENV
          echo "DERIVED_DATA_PATH=${{ github.workspace }}/build/ios_derived" >> $GITHUB_ENV

      - name: ğŸ“¦ Build unsigned IPA
        env:
          XCODE_DERIVED_DATA_PATH: ${{ github.workspace }}/build/ios_derived
          SYMROOT: ${{ github.workspace }}/build/ios_derived
          DERIVED_DATA_PATH: ${{ github.workspace }}/build/ios_derived
        run: flutter build ipa --release --no-codesign --verbose --dart-define=CI_BUILD=true

      - name: ğŸ” Debug: List generated IPA files
        run: ls -l build/ios/ipa || echo "No IPA generated"

      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: cyanase_ios_ipa_unsigned
          path: build/ios/ipa/*.ipa
