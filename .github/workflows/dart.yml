name: cyanase_ipa

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
          flutter-version: '3.24.0'

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod setup

      - name: Clean build
        run: |
          flutter clean
          cd ios
          rm -rf Pods/
          rm -rf .symlinks/
          rm -rf Flutter/Flutter.framework
          rm -rf Flutter/Flutter.podspec
          cd ..

      - name: Get dependencies
        run: |
          flutter pub get
          flutter pub outdated
          flutter pub upgrade --major-versions

      - name: Setup iOS build
        run: |
          cd ios
          pod deintegrate
          pod cache clean --all
          pod install
          cd ..

      - name: Build iOS
        run: |
          flutter build ios --release --no-codesign
        env:
          FLUTTER_BUILD_NUMBER: ${{ github.run_number }}
          FLUTTER_BUILD_NAME: "1.0.0"
          FLUTTER_FORCE_XCODE_WORKSPACE: "true"

      - name: Set permissions
        run: |
          sudo chown -R $(whoami) build
          sudo chmod -R 755 build

      - name: Create IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          mv Runner.app Payload/
          zip -qq -r -9 FlutterIpaExport.ipa Payload
          cd ../../..

      - name: Upload IPA
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0.${{ github.run_number }}
          overwrite: true
          body: |
            iOS Build #${{ github.run_number }}
            - Build Date: ${{ github.event.repository.updated_at }}
            - Commit: ${{ github.sha }}
