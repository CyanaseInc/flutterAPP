name: Build iOS IPA

on:
  workflow_dispatch:

jobs:
  build:
    name: ğŸ—ï¸ Build IPA for iOS
    runs-on: macos-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”§ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0' # or whatever you're using
          channel: stable

      - name: ğŸ“¦ Install Flutter dependencies
        run: flutter pub get

      - name: ğŸ› ï¸ Build Flutter iOS artifacts
        run: flutter build ios --release --no-codesign

      - name: ğŸ Install CocoaPods
        run: |
          cd ios
          pod install
          cd ..

      - name: ğŸ”§ Patch Pod xcconfig (disable bitcode and others)
        run: |
          echo 'Updating Pod settings...'
          find ios/Pods/Target\ Support\ Files -name "*.xcconfig" -print0 | xargs -0 sed -i '' 's/ENABLE_BITCODE = YES/ENABLE_BITCODE = NO/g'
          find ios/Pods/Target\ Support\ Files -name "*.xcconfig" -print0 | xargs -0 sed -i '' 's/BUILD_LIBRARY_FOR_DISTRIBUTION = YES/BUILD_LIBRARY_FOR_DISTRIBUTION = NO/g'

      - name: ğŸ§¯ Patch Runner project to disable module interfaces
        run: |
          gem install xcodeproj
          ruby -e '
            require "xcodeproj"
            proj = Xcodeproj::Project.open("ios/Runner.xcodeproj")
            proj.targets.each do |target|
              if target.name == "Runner"
                target.build_configurations.each do |config|
                  config.build_settings["BUILD_LIBRARY_FOR_DISTRIBUTION"] = "NO"
                end
              end
            end
            proj.save
          '

      - name: ğŸ—ï¸ Rebuild iOS for distribution
        run: flutter build ios --release --no-codesign

      - name: ğŸ“¦ Archive .ipa
        run: |
          cd ios
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r Runner.ipa Payload
          mv Runner.ipa ../Runner.ipa

      - name: ğŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Cyanase-Runner-IPA
          path: Runner.ipa
