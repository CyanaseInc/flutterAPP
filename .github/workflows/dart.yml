name: cyanase_ipa

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-14

    steps:
      # Checkout the code
      - uses: actions/checkout@v3

      # Set up Ruby for CocoaPods
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      # Set up Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
          flutter-version: '3.32.2'

      # Install CocoaPods
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod setup

      # Clean previous build artifacts
      - name: Clean build
        run: |
          flutter clean
          rm -rf build
          cd ios
          rm -rf Pods/
          rm -rf .symlinks/
          rm -rf Flutter/Flutter.framework
          rm -rf Flutter/Flutter.podspec
          cd ..

      # Get Flutter dependencies
      - name: Get dependencies
        run: flutter pub get

      # Pod cleanup and fresh install
      - name: Setup iOS build
        run: |
          cd ios
          pod deintegrate
          pod cache clean --all
          pod install
          cd ..

      # Set iOS deployment target to 12.0
      - name: Set Xcode deployment target
        run: |
          cd ios
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = .*/IPHONEOS_DEPLOYMENT_TARGET = 12.0;/' Runner.xcodeproj/project.pbxproj
          cd ..

      # Ensure correct CocoaPods base configuration
      - name: Set CocoaPods base config
        run: |
          cd ios
          for config in "Release" "Debug"; do
            plutil -replace baseConfigurationReference -string "Pods/Target Support Files/Pods-Runner/Pods-Runner.${config}.xcconfig" Runner.xcodeproj/project.pbxproj || true
          done
          cd ..

      # Set permissions for the whole project (fixes write errors)
      - name: Set project directory permissions
        run: |
          sudo chown -R $(whoami) .
          sudo chmod -R 777 .

      # Set permissions for build and ios directories after pod install
      - name: Set permissions for build and ios directories
        run: |
          if [ -d "build" ]; then
            sudo chown -R $(whoami) build
            sudo chmod -R 777 build
          fi
          sudo chown -R $(whoami) ios
          sudo chmod -R 777 ios

      # Fix Bitcode setting for iOS (avoid CocoaPods ENABLE_BITCODE conflict)
      - name: Disable Bitcode for iOS
        run: |
          cd ios
          plutil -replace ENABLE_BITCODE -bool NO Runner.xcodeproj/project.pbxproj || true
          sed -i '' '/ENABLE_BITCODE =/d' Runner.xcodeproj/project.pbxproj
          cd ..

      # Disable code signing for CI
      - name:
